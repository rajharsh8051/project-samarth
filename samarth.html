<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Samarth - Intelligent Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #chat-window {
            height: calc(100vh - 200px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.6;
        }
        .message-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .message-assistant {
            background-color: white;
            color: #1f2937;
            align-self: flex-start;
            border: 1px solid #e5e7eb;
        }
        .message-assistant strong {
            color: #111827;
        }
        .message-assistant ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-top: 8px;
        }
        .message-assistant ol {
            list-style-type: decimal;
            margin-left: 20px;
            margin-top: 8px;
        }
        .source-list {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        .source-list h4 {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        .source-list li {
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .source-list a {
            color: #3b82f6;
            text-decoration: none;
            word-break: break-all;
        }
        .source-list a:hover {
            text-decoration: underline;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl border border-gray-200" style="height: 90vh;">
        <!-- Header -->
        <div class="border-b border-gray-200 p-4">
            <h1 class="text-2xl font-bold text-gray-800">Project Samarth ðŸ‡®ðŸ‡³</h1>
            <p class="text-sm text-gray-600">Intelligent Q&A for India's Agriculture & Climate Data (from data.gov.in)</p>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="p-4 md:p-6 space-y-4 flex flex-col">
            <!-- Initial Message -->
            <div class="message message-assistant">
                Hello! I am Samarth, an AI assistant for analyzing India's public data.
                <br><br>
                Please ask me complex questions about the agricultural economy and climate patterns. I will do my best to answer using live data from <strong>data.gov.in</strong> and provide citations for traceability.
                <br><br>
                <strong>Try one of the sample questions:</strong>
                <ul class="mt-2 text-sm">
                    <li>"Compare the average annual rainfall in Maharashtra and Punjab for the last 5 available years."</li>
                    <li>"What is the total production of Rice in West Bengal vs. Uttar Pradesh in the most recent year available on data.gov.in?"</li>
                </ul>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 border-t border-gray-200">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="chat-input" placeholder="Ask a complex, data-driven question..."
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="submit" id="send-button"
                    class="bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm active:scale-95">
                    Send
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        // --- Gemini API Configuration ---
        // NOTE: Leave apiKey as ""
        // Canvas will automatically provide a key in the production environment.
        const apiKey = ""; 
        const genModel = `gemini-2.5-flash-preview-09-2025`;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${genModel}:generateContent?key=${apiKey}`;

        // --- System Instruction (The Core Logic) ---
        const SYSTEM_INSTRUCTION = `You are 'Project Samarth,' an AI data analyst. Your mission is to answer complex questions about India's agricultural economy and its relationship with climate patterns, fulfilling the user's request.

        RULES:
        1.  **Source Data:** You MUST source your information *only* from the 'data.gov.in' portal. Your search tool is optimized for this.
        2.  **Answer:** You MUST provide a clear, data-backed answer to the user's question. Synthesize information from multiple sources if needed.
        3.  **Citation (Mandatory):** You MUST cite the specific 'data.gov.in' dataset, page, or document for *every* data point you use. Use the grounding metadata provided to you. List these as "Sources" at the end of your answer.
        4.  **No Data:** If you cannot find the specific information on 'data.gov.in', you must state that clearly rather than providing data from other sources.
        5.  **Format:** Present data clearly. Use lists and bold text for comparisons.
        `;

        // --- DOM Elements ---
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // --- Form Submission Handler ---
        chatForm.addEventListener('submit', handleQuery);

        async function handleQuery(e) {
            e.preventDefault();
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;

            displayUserMessage(userQuery);
            chatInput.value = '';
            displayLoadingIndicator();

            try {
                // --- API Call with Google Search Grounding ---
                const payload = {
                    contents: [{
                        parts: [{ text: userQuery }]
                    }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_INSTRUCTION }]
                    },
                    tools: [{
                        "google_search": {} // Enables real-time, grounded search
                    }],
                };

                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                // --- Process Response ---
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // Extract sources for Traceability
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({
                                uri: attr.web?.uri,
                                title: attr.web?.title,
                            }))
                            .filter(source => source.uri && source.title); // Ensure sources are valid
                    }
                    
                    displaySamarthResponse(text, sources);

                } else {
                    displayError("I'm sorry, I couldn't retrieve a valid response. Please try again.");
                }

            } catch (error) {
                console.error('Error calling Gemini API:', error);
                displayError(`An error occurred: ${error.message}. Please check your connection and try again.`);
            } finally {
                removeLoadingIndicator();
            }
        }

        // --- Display Functions ---
        function displayUserMessage(query) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-user';
            messageDiv.textContent = query;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        function displaySamarthResponse(text, sources = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-assistant';
            
            // Basic Markdown to HTML conversion
            let htmlContent = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                .replace(/^- (.*?)(\n|$)/gm, '<li>$1</li>') // List items
                .replace(/(\n<li>.*<\/li>)/g, '<ul>$1\n</ul>') // Wrap lists
                .replace(/\n/g, '<br>'); // Newlines

            // Add Sources (Fulfills Traceability requirement)
            if (sources.length > 0) {
                htmlContent += `<div class="source-list">
                    <h4>Sources from data.gov.in:</h4>
                    <ul>`;
                
                // Deduplicate sources by URI
                const uniqueSources = new Map();
                sources.forEach(source => {
                    if (!uniqueSources.has(source.uri)) {
                        uniqueSources.set(source.uri, source);
                    }
                });

                uniqueSources.forEach(source => {
                    htmlContent += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title || source.uri}</a></li>`;
                });
                
                htmlContent += `</ul></div>`;
            }
            
            messageDiv.innerHTML = htmlContent;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message message-assistant';
            errorDiv.innerHTML = `<span class="text-red-600 font-semibold">Error:</span> ${message}`;
            chatWindow.appendChild(errorDiv);
            scrollToBottom();
        }

        function displayLoadingIndicator() {
            const loaderDiv = document.createElement('div');
            loaderDiv.id = 'loading-indicator';
            loaderDiv.className = 'message message-assistant flex justify-center items-center';
            loaderDiv.innerHTML = '<div class="loader"></div>';
            chatWindow.appendChild(loaderDiv);
            scrollToBottom();
            sendButton.disabled = true;
        }

        function removeLoadingIndicator() {
            const loader = document.getElementById('loading-indicator');
            if (loader) {
                loader.remove();
            }
            sendButton.disabled = false;
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- Exponential Backoff Retry Fetch ---
        async function retryFetch(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // Do not retry on client-side errors, only server-side/rate limits
                    if (response.status >= 400 && response.status < 500) {
                        throw new Error(`Client Error: ${response.status} ${response.statusText}`);
                    }
                    // Wait and retry
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                } catch (error) {
                    if (i === retries - 1) throw error; // Last retry failed
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

    </script>
</body>
</html>
